#!/usr/bin/env python
""" Calculate psd estimates for analysis segments
"""
import logging, argparse, numpy, h5py
import pycbc, pycbc.strain, pycbc.dq
from pycbc.version import git_verbose_msg as version
from pycbc.fft.fftw import set_measure_level
from pycbc.events.veto import segments_to_start_end
set_measure_level(0)

parser = argparse.ArgumentParser(description=__doc__)
parser.add_argument('--version', action='version', version=version)
parser.add_argument('--verbose', action="store_true")
parser.add_argument("--science-name", help="Science flag definition")
parser.add_argument("--segment-server")
parser.add_argument("--veto-definer-file")
parser.add_argument("--instrument")
parser.add_argument("--output-file", required=True)

pycbc.strain.insert_strain_option_group(parser)

args = parser.parse_args()
pycbc.init_logging(args.verbose)

logging.info('Querying science segemnts')
segs = pycbc.dq.query_str(args.instrument,
                          args.science_name,
                          args.gps_start_time,
                          args.gps_end_time,
                          server=args.segment_server,
                          veto_definer=args.veto_definer_file)
logging.info('Found %s segments, %ss total', len(segs), abs(segs))

f = h5py.File(args.output_file, 'w')
starts, ends = segments_to_start_end(segs)
f['segments/start'] = starts
f['segments/end'] = ends

for i, seg in enumerate(segs):
    logging.info('Processing science segment %s/%s of duration %ss',
                 i, len(segs), abs(seg))
    args.gps_start_time = seg[0]
    args.gps_end_time = seg[1]
    ht = pycbc.strain.from_cli(args, pycbc.DYN_RANGE_FAC)

logging.info('Done!')
